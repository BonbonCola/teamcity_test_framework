name: TeamCity Setup  # ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ composite-action'Ð°

runs:
  using: "composite"  # Ð£ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼, Ñ‡Ñ‚Ð¾ ÑÑ‚Ð¾ ÑÐ¾ÑÑ‚Ð°Ð²Ð½Ð¾Ð¹ (composite) action
  steps:

    - name: Set up Python  # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Python, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¼Ð¾Ð¶Ð½Ð¾ Ð±Ñ‹Ð»Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ pytest
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"  # Ð’ÐµÑ€ÑÐ¸Ñ Python, ÐºÐ¾Ñ‚Ð¾Ñ€ÑƒÑŽ Ð±ÑƒÐ´ÐµÐ¼ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ

    - name: Install ifconfig  # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ net-tools (Ð² Ubuntu ifconfig Ð½Ðµ Ð¿Ñ€ÐµÐ´ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½)
      shell: bash
      run: sudo apt-get update && sudo apt-get install -y net-tools

    - name: Set HOST environment variable  # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð²Ð½ÐµÑˆÐ½Ð¸Ð¹ IP Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ Ð¼Ð°ÑˆÐ¸Ð½Ñ‹, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¾Ð±Ñ€Ð°Ñ‰Ð°Ñ‚ÑŒÑÑ Ðº ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°Ð¼ Ð¸Ð·Ð²Ð½Ðµ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ð¸Ð· Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ð° Ð² Selenoid) Ð¸ ÐºÐ»Ð°Ð´ÐµÐ¼ Ð² Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ Ð³Ð¸Ñ‚Ñ…Ð°Ð± ÑÐºÑˆÐ½Ñ
      shell: bash
      run: |
        echo "HOST=$(ifconfig | grep -Eo 'inet [0-9.]+' | grep -v '127.0.0.1' | awk '{ print $2 }' | head -n1)" >> $GITHUB_ENV

    - name: Copy browsers config to working dir
      shell: bash
      run: cp selenoid/config/browsers.json ./browsers.json

    - name: Pull Selenoid browsers  # Ð˜Ð· Ñ„Ð°Ð¹Ð»Ð° selenoid/config/browsers.json Ð´Ð¾ÑÑ‚Ð°Ñ‘Ð¼ Ð¸Ð¼ÐµÐ½Ð° Docker-Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð² Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ð¾Ð² Ð¸ ÑÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð¸Ñ…
      shell: bash
      run: |
        for browser in $(awk -F'"' '/"image": "/{print $4}' browsers.json); do
          docker pull $browser
        done

    - name: Run Selenoid  # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ñ Selenoid â€” ÑÑ‚Ð¾ Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ ÑÐµÑ€Ð²ÐµÑ€, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ð°Ð¼Ð¸
      shell: bash
      run: |
        docker run -d --name selenoid -v /var/run/docker.sock:/var/run/docker.sock -v $(pwd)/selenoid/config/:/etc/selenoid/:ro -p 4444:4444 aerokube/selenoid:latest-release                         

    - name: Run TeamCity Server  # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ TeamCity Ð² ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ðµ, Ð¤Ð»Ð°Ð³ -d Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ð² Ñ„Ð¾Ð½Ð¾Ð²Ð¾Ð¼ Ñ€ÐµÐ¶Ð¸Ð¼Ðµ, ÐµÑÐ»Ð¸ Ð¼Ñ‹ ÑÑ‚Ð¾Ð³Ð¾ Ð½Ðµ ÑÐ´ÐµÐ»Ð°ÐµÐ¼, Ð¼Ñ‹ Ð½Ð¸ÐºÐ¾Ð³Ð´Ð° Ð½Ðµ Ð¿ÐµÑ€ÐµÐ¹Ð´ÐµÐ¼ Ðº ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ¼Ñƒ ÑÑ‚ÐµÐ¿Ñƒ
      shell: bash
      run: |
        docker run -u 0 -d --name teamcity-server -v $(pwd)/tmp/teamcity_server/datadir:/data/teamcity_server/datadir -v $(pwd)/tmp/teamcity_server/logs:/opt/teamcity/logs -p 8111:8111 jetbrains/teamcity-server:2023.11.1 

    - name: Patch env_config.toml with actual values  # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ð¼Ð¸ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸ÑÐ¼Ð¸ (IP, Ñ‚Ð¾ÐºÐµÐ½, Ð¿Ð¾Ñ€Ñ‚Ñ‹)
      shell: bash
      run: |
        echo "ðŸ”§ Updating env_config.toml"
        sed -i.bak "s|base_url = .*|base_url = \"http://$HOST:8111\"|" main/api/configs/env_config.toml
        sed -i.bak "s|internal_base_url = .*|internal_base_url = \"http://$HOST:8111\"|" main/api/configs/env_config.toml
        sed -i.bak "s|selenoid_url = .*|selenoid_url = \"http://$HOST:4444/wd/hub\"|" main/api/configs/env_config.toml
        sed -i.bak "s|superusertoken = .*|superusertoken = \"$SUPER_USER_TOKEN\"|" main/api/configs/env_config.toml

    - name: Setup TeamCity Server (via pytest) # ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ TeamCity Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ Ñ‚ÐµÑÑ‚Ð°
      shell: bash
      run: |
        echo "ðŸ©º ÐžÐ¶Ð¸Ð´Ð°ÐµÐ¼, Ð¿Ð¾ÐºÐ° TeamCity Ð¿Ð¾Ð´Ð½Ð¸Ð¼ÐµÑ‚ÑÑ..."
        until curl -s "http://$HOST:8111" | grep -q "TeamCity"; do
          echo "â³ Ð–Ð´Ñ‘Ð¼ TeamCity Ð½Ð° $HOST:8111..."
          sleep 10
        done
        echo "âœ… TeamCity Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½! Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ‚ÐµÑÑ‚"
        PYTHONPATH=. pytest tests/ui_tests/test_setup_server.py::TestSetupServer::test_setup_teamcity_server         

    - name: Extract SUPER_USER_TOKEN  # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ‚Ð¾ÐºÐµÐ½ ÑÑƒÐ¿ÐµÑ€Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¸Ð· Ð»Ð¾Ð³Ð¾Ð² TeamCity Ð¸ ÐºÐ»Ð°Ð´ÐµÐ¼ Ð² Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ Ð³Ð¸Ñ‚Ñ…Ð°Ð± ÑÐºÑˆÐ½Ñ
      shell: bash
      run: |
        echo "SUPER_USER_TOKEN=$(docker logs teamcity-server | grep 'Super user authentication token' | tail -n 1 | awk '{print \$6}')" >> $GITHUB_ENV



