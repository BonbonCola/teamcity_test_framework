name: TeamCity Setup  # –ù–∞–∑–≤–∞–Ω–∏–µ composite-action'–∞

runs:
  using: "composite"  # –£–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ —ç—Ç–æ —Å–æ—Å—Ç–∞–≤–Ω–æ–π (composite) action
  steps:

    - name: Set up Python  # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –∑–∞–ø—É—Å–∫–∞—Ç—å pytest
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"  # –í–µ—Ä—Å–∏—è Python, –∫–æ—Ç–æ—Ä—É—é –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

    - name: Install ifconfig  # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º net-tools (–≤ Ubuntu ifconfig –Ω–µ –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
      shell: bash
      run: sudo apt-get update && sudo apt-get install -y net-tools

    - name: Set HOST environment variable  # –ü–æ–ª—É—á–∞–µ–º –≤–Ω–µ—à–Ω–∏–π IP —Ç–µ–∫—É—â–µ–π –º–∞—à–∏–Ω—ã, —á—Ç–æ–±—ã –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º –∏–∑–≤–Ω–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞ –≤ Selenoid)
      shell: bash
      run: |
        echo "HOST=$(ifconfig | grep -Eo 'inet [0-9.]+' | grep -v '127.0.0.1' | awk '{ print $2 }' | head -n1)" >> $GITHUB_ENV

    - name: Pull Selenoid browsers  # –ò–∑ —Ñ–∞–π–ª–∞ selenoid/config/browsers.json –¥–æ—Å—Ç–∞—ë–º –∏–º–µ–Ω–∞ Docker-–æ–±—Ä–∞–∑–æ–≤ –±—Ä–∞—É–∑–µ—Ä–æ–≤ –∏ —Å–∫–∞—á–∏–≤–∞–µ–º –∏—Ö
      shell: bash
      run: |
        for browser in $(awk -F'"' '/"image": "/{print $4}' selenoid/config/browsers.json); do
          docker pull $browser
        done

    - name: Run Selenoid  # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å Selenoid ‚Äî —ç—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π —É–ø—Ä–∞–≤–ª—è–µ—Ç –±—Ä–∞—É–∑–µ—Ä–∞–º–∏
      shell: bash
      run: |
        docker run -d --name selenoid \
          -v /var/run/docker.sock:/var/run/docker.sock \ 
          -v $(pwd)/selenoid/config/:/etc/selenoid/:ro \    
          -p 4444:4444 \                                             
          aerokube/selenoid:latest-release                         

    - name: Run TeamCity Server  # –ó–∞–ø—É—Å–∫–∞–µ–º TeamCity –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
      shell: bash
      run: |
        docker run -u 0 -d --name teamcity-server \                   
          -v $(pwd)/tmp/teamcity_server/datadir:/data/teamcity_server/datadir \  
          -v $(pwd)/tmp/teamcity_server/logs:/opt/teamcity/logs \  
          -p 8111:8111 \                                          
          jetbrains/teamcity-server:2023.11.1               

    - name: Setup TeamCity Server (via pytest)  # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º TeamCity –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å –ø–æ–º–æ—â—å—é —Ç–µ—Å—Ç–∞
      shell: bash
      run: |
        sleep 30 
        pytest tests/ui_tests/test_setup_server.py::TestSetupServer::test_setup_teamcity_server

    - name: Extract SUPER_USER_TOKEN  # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ª–æ–≥–æ–≤ TeamCity
      shell: bash
      run: |
        echo "SUPER_USER_TOKEN=$(docker logs teamcity-server | grep 'Super user authentication token' | tail -n 1 | awk '{print \$6}')" >> $GITHUB_ENV

    - name: Patch env_config.toml with actual values  # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª –ø—Ä–æ–µ–∫—Ç–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ (IP, —Ç–æ–∫–µ–Ω, –ø–æ—Ä—Ç—ã)
      shell: bash
      run: |
        echo "üîß Updating env_config.toml"
        sed -i.bak "s|base_url = .*|base_url = \"http://$HOST:8111\"|" main/api/configs/env_config.toml
        sed -i.bak "s|internal_base_url = .*|internal_base_url = \"http://$HOST:8111\"|" main/api/configs/env_config.toml
        sed -i.bak "s|selenoid_url = .*|selenoid_url = \"http://$HOST:4444/wd/hub\"|" main/api/configs/env_config.toml
        sed -i.bak "s|superusertoken = .*|superusertoken = \"$SUPER_USER_TOKEN\"|" main/api/configs/env_config.toml
